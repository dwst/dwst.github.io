!function(t){var e={};function n(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(s,r,function(e){return t[e]}.bind(null,r));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);class s{constructor(t){this._remainder=t}get length(){return this._remainder.length}startsWith(t){return this._remainder.startsWith(t)}read(t){return!1!==this._remainder.startsWith(t)&&(this._remainder=this._remainder.slice(t.length),!0)}readUntil(t){const e=function(t,e){const n=new Set(e.map(e=>t.indexOf(e)));return n.delete(-1),0===n.size?-1:Math.min(...n)}(this._remainder,t);let n;n=-1===e?this._remainder.length:e;const s=this._remainder.slice(0,n);return this._remainder=this._remainder.slice(n),s}readWhile(t,e=1/0){const n=function(t,e){const n=t.split("").map(t=>e.includes(t)).indexOf(!1);return-1===n?t.length:n}(this._remainder,t),s=Math.min(n,e),r=this._remainder.slice(0,s);return this._remainder=this._remainder.slice(s),r}toString(){return this._remainder}}class r extends Error{constructor(){if(super(),new.target===r)throw new Error("abstract")}}var o={NoConnection:class extends r{constructor(t){super(),this.msg=t}},AlreadyConnected:class extends r{},SocketError:class extends r{},InvalidTemplateExpression:class extends r{constructor(t,e,n=null){super(),this.expected=t,this.remainder=e,this.expression=n}get errorPosition(){return this.expression.length-this.remainder.length}},InvalidArgument:class extends r{constructor(t,e){super(),this.argument=t,this.extraInfo=e}},InvalidCombination:class extends r{constructor(t,e){super(),this.command=t,this.commands=e}},InvalidUtf8:class extends r{constructor(t){super(),this.buffer=t}},InvalidDataType:class extends r{constructor(t,e){super(),this.variable=t,this.expected=e}},InvalidVariableName:class extends r{constructor(t){super(),this.variable=t}},UnknownCommand:class extends r{constructor(t){super(),this.command=t}},UnknownInstruction:class extends r{constructor(t){super(),this.instruction=t}},UnknownHelpPage:class extends r{constructor(t){super(),this.page=t}},UnknownVariable:class extends r{constructor(t){super(),this.variable=t}}},i={parseNum:t=>{if(t.length>2&&"0x"===t.substr(0,2))return parseInt(t.substr(2),16);return parseInt(t,10)},chunkify:(t,e)=>{const n=[];let s=[],r=0;for(const o of t)r>=e&&(n.push(s),s=[],r=0),s.push(o),r+=1;return n.push(s),n},range:(t,e=null)=>{let n,s;return null===e?(n=0,s=t):(n=t,s=e),Array(s-n).fill().map((t,e)=>n+e)},htmlescape:t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),joinBuffers:t=>{let e=0;for(const n of t)e+=n.length;const n=new Uint8Array(e);let s=0;for(const e of t)n.set(e,s),s+=e.length;return n}};const{InvalidTemplateExpression:l}=o,a=["$","\\"];function c(t,e){const n=t.charCodeAt(0),s=e.charCodeAt(0);return i.range(n,s+1).map(t=>String.fromCharCode(t))}const u=c("0","9"),d=c("a","f").concat(u),h=c("a","z"),m=c("A","Z"),f=h.concat(m),p=d.concat(["x"]),g=f;function w(t){return`"${t}"`}function y(t){for(;t.read(" "););}function _(t){const e=[["\\","\\"],["$","$"],["n","\n"],["r","\r"],["0","\0"],["x",null],["u",null]];if(t.read("x"))return function(t){const e=t.readWhile(d,2);if(e.length<2)throw new l(["hex digit"],String(t));return{type:"byte",value:parseInt(e,16)}}(t);if(t.read("u"))return function(t){let e;if(t.read("{")){if((e=t.readWhile(d,6)).length<1)throw new l(["hex digit"],String(t));if(0===t.length)throw new l(["hex digit",'"}"'],String(t));if(!1===t.read("}"))throw new l(['"}"'],String(t))}else{if((e=t.readWhile(d,4)).length<1)throw new l(["hex digit",'"{"'],String(t));if(e.length<4)throw new l(["hex digit"],String(t))}return{type:"codepoint",value:parseInt(e,16)}}(t);if(t.length>0)for(const[n,s]of e)if(t.read(n))return{type:"text",value:s};const n=e.map(t=>t[0]);throw new l(n.map(w),String(t))}function b(t){if(t.read("0x")){const e=t.readWhile(d);if(0===e.length)throw new l(["hex digit"],String(t));return{type:"int",value:parseInt(e,16)}}const e=t.readWhile(u);if(0===e.length)throw new l(["an integer"],String(t));return{type:"int",value:parseInt(e,10)}}function v(t){const e=function(t){const e=t.readWhile(g);if(0===e.length)throw new l(["a function name","a variable name"],String(t));if(0===t.length)throw new l(["(","}"].map(w),String(t));return e}(t);if(y(t),t.startsWith("(")){!function(t){if(!1===t.read("("))throw new Error("unexpected return value")}(t),y(t);const n=function(t){const e=[];if(t.startsWith(")"))return e;if(!1===p.some(e=>t.startsWith(e))){const e=["an integer"].concat([")"].map(w));throw new l(e,String(t))}for(;;){const n=b(t);if(e.push(n),y(t),t.startsWith(")"))return e;if(!1===t.read(","))throw new l([",",")"].map(w),String(t));y(t)}}(t);return y(t),function(t){if(!1===t.read(")"))throw new Error("unexpected return value")}(t),{type:"function",name:e,args:n}}if(t.startsWith("}"))return{type:"variable",name:e};throw new l(["(","}"].map(w),String(t))}function x(t){if(t.read("\\"))return _(t);if(t.read("$")){!function(t){const e="{";if(!1===t.read(e))throw new l([e].map(w),String(t))}(t),y(t);const e=v(t);return y(t),function(t){const e="}";if(!1===t.read(e))throw new l([e].map(w),String(t))}(t),e}return function(t){return{type:"text",value:t.readUntil(a)}}(t)}var S={parseTemplateExpression:function(t){const e=new s(t);try{return function(t){const e=[];for(;t.length>0;){const n=x(t);e.push(n)}return{type:"templateExpression",particles:e}}(e)}catch(e){throw e instanceof l&&(e.expression=t),e}},escapeForTemplateExpression:function(t){return function t(e,n){if(n.length<1)return e;const s=n[0],r=s[0],o=s[1],i=e.split(r),l=[];for(const e of i){const s=t(e,n.slice(1));l.push(s)}return l.join(o)}(t,[["$","\\$"],["\\","\\\\"]])},isValidVariableName:function(t){return t===new s(t).readWhile(g)}};const C={"\0":["\\0","NUL","null terminator"],"":[null,"SOH","start of heading"],"":[null,"STX","start of text"],"":[null,"ETX","end of text"],"":[null,"EOT","end of transmission"],"":[null,"ENQ","enquiry"],"":[null,"ACK","acknowledge"],"":[null,"BEL","bell"],"\b":[null,"BS","backspace"],"\t":[null,"HT","horizontal tabulation"],"\n":["\\n","LF","line feed"],"\v":[null,"VT","vertical tabulation"],"\f":[null,"FF","form feed"],"\r":["\\r","CR","carriage return"],"":[null,"SO","shift out"],"":[null,"SI","shift in"],"":[null,"DLE","data link escape"],"":[null,"DC1","device control one"],"":[null,"DC2","device control two"],"":[null,"DC3","device control three"],"":[null,"DC4","device control four"],"":[null,"NAK","negative acknowledge"],"":[null,"SYN","synchronous idle"],"":[null,"ETB","end of transmission block"],"":[null,"CAN","cancel"],"":[null,"EM","end of medium"],"":[null,"SUB","substitute"],"":[null,"ESC","escape"],"":[null,"FS","file separator"],"":[null,"GS","group separator"],"":[null,"RS","record separator"],"":[null,"US","unit separator"],"":[null,"DEL","delete"],"¬Ä":[null,"XXX","<control>"],"¬Å":[null,"XXX","<control>"],"¬Ç":[null,"BPH","break permitted here"],"¬É":[null,"NBH","no break here"],"¬Ñ":[null,"IND","index"],"¬Ö":[null,"NEL","next line"],"¬Ü":[null,"SSA","start of selected area"],"¬á":[null,"ESA","end of selected area"],"¬à":[null,"HTS","character tabulation set"],"¬â":[null,"HTJ","character tabulation with justification"],"¬ä":[null,"VTS","line tabulation set"],"¬ã":[null,"PLD","partial line forward"],"¬å":[null,"PLU","partial line backward"],"¬ç":[null,"RI","reverse line feed"],"¬é":[null,"SS2","single shift two"],"¬è":[null,"SS3","single shift three"],"¬ê":[null,"DCS","device control string"],"¬ë":[null,"PU1","private use one"],"¬í":[null,"PU2","private use two"],"¬ì":[null,"STS","set transmit state"],"¬î":[null,"CCH","cancel character"],"¬ï":[null,"MW","message waiting"],"¬ñ":[null,"SPA","start of guarded area"],"¬ó":[null,"EPA","end of guarded area"],"¬ò":[null,"SOS","start of string"],"¬ô":[null,"XXX","<control>"],"¬ö":[null,"SCI","single character introducer"],"¬õ":[null,"CSI","control sequence introducer"],"¬ú":[null,"ST","string terminator"],"¬ù":[null,"OSC","operating system command"],"¬û":[null,"PM","privacy message"],"¬ü":[null,"APC","application program command"],"¬†":[null,"NBSP","no-break space"],"¬≠":[null,"SHY","soft hyphen"]},$=Object.keys(C);function k(t){for(const[e,[n,s,r]]of Object.entries(C))if(t.read(e))return{chr:e,nice:n,abbr:s,name:r};return t.readUntil($)}function E(t){const e=[],n=new s(t);for(;n.length>0;){const t=k(n);e.push(t)}return e}var A={control:E,utils:i,parser:S};class T{constructor(){if(new.target===T)throw new Error("abstract")}}function I(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function*L(...t){for(;;){const e=t.map(t=>t.next());for(const t of e)void 0!==t.value&&(yield t.value);if(e.every(t=>t.done))return}}function P(...t){return function([t,...e],n){return[t].concat(e.flatMap(t=>[n,t]))}(t," ").flat()}function N(t,e=t,n={}){return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},s=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),s.forEach(function(e){I(t,e,n[e])})}return t}({warning:!1,spacing:!1,wrap:!0,afterText:null},n,{type:"help",text:t,section:e})}var U={h1:t=>({type:"h1",text:t}),h2:t=>({type:"h2",text:t}),unsafe:t=>({type:"regular",text:t,unsafe:!0}),regular:t=>({type:"regular",text:t}),strong:t=>({type:"strong",text:t}),command:t=>({type:"command",text:t}),link:(t,e=t)=>({type:"link",text:e,url:t}),syntax:t=>({type:"syntax",text:t}),code:t=>({type:"code",text:t}),control:(t,e)=>({type:"control",text:t,title:e}),hexline:(t,e)=>({type:"hexline",text:e,hexes:t}),line:(t,...e)=>(function(t,e){return[...L(t[Symbol.iterator](),e[Symbol.iterator]())]})(t,e),help:N,paragraph:P,sectionList:function(t){return P(...t.sort().map((t,e,n)=>N(t,t,e<n.length-1?{spacing:!0,wrap:!1,afterText:","}:{spacing:!0,wrap:!1})))}},W={abstract:{DwstError:r,DwstFunction:T},errors:o,m:U,util:{Parsee:s}};var D={appVersion:"2.5.9",echoServer:"wss://echo.websocket.org/"};class B{constructor(t=[]){if(!Array.isArray(t))throw new Error("invalid history saveState");this.idx=-1,this.history=t}get length(){return this.history.length}getAll(){return this.history}getNext(){return this.idx>0?(this.idx-=1,this.history[this.idx]):0===this.idx?(this.idx-=1,""):""}getPrevious(){return 0===this.history.length?"":this.idx+1<this.history.length?(this.idx+=1,this.history[this.idx]):this.history[this.history.length-1]}gotoBottom(){this.idx=-1}getLast(){return this.history[0]}addItem(t,e,n){if("string"!=typeof t)throw new Error("invalid type");""!==t&&t!==this.getLast()&&(this.history.unshift(t),e&&(this.idx+=1)),n()}removeBottom(){this.history.shift()}getCurrent(){return this.history[this.idx]}getConnectCommands(t){const e=[],n=new Set;for(const s of this.history)if(s.startsWith("/connect ")&&!n.has(s)&&(e.push(s),n.add(s)),e.length>=t)return e;return e}}class H{constructor(t,e){this.save=e.save,this.history=new B(t)}getHistoryLength(){return this.history.length}getSummary(){const t=this.history.getAll(),e=["History "];return t.length<1?e.push("is empty"):(e.push("contains "),e.push(U.strong(`${t.length}`)),1===t.length?e.push(" command"):e.push(" commands")),e}forget(){const t=[];this.history=new B(t,{save:this.save}),this.save(t)}addItem(t,e){this.history.addItem(t,e,()=>{const t=this.history.getAll();this.save(t)})}getNext(t){return t!==this.history.getCurrent()&&this.addItem(t,!0),this.history.getNext()}getPrevious(t){return t!==this.history.getCurrent()&&this.addItem(t,!0),this.history.getPrevious()}select(t){this.addItem(t),this.history.gotoBottom()}atBottom(){return-1===this.history.idx}getConnectCommands(t){return this.history.getConnectCommands(t)}}class j{constructor(t,e){this._dwst=t,this._functions=new Map,this._variables=new Map;for(const n of e){const e=new n(t);for(const t of e.commands())this._functions.set(t,e)}}setVariable(t,e){if(!1===this._dwst.lib.parser.isValidVariableName(t))throw new this._dwst.types.errors.InvalidVariableName(t);this._variables.set(t,e)}getVariable(t){const e=this._variables.get(t);return void 0!==e?e:this.getFunction(t)}deleteVariable(t){this._variables.delete(t)}getVariableNames(){return[...this._variables.keys()]}getFunction(t){const e=this._functions.get(t);return void 0!==e?e:null}getFunctionNames(){return[...this._functions.keys()]}}const M=[U.h2("!!! Follow at your own risk !!!"),"","Disabling security is generally a bad idea and you should only do it if you understand the implications."];const O=["git clone https://github.com/dwst/dwst.git","cd dwst","npm install -g yarn","yarn","gulp dev"].map(U.code);const V=[U.h2("!!! Follow at your own risk !!!"),"","Disabling security is generally a bad idea and you should only do it if you understand the implications."];const F=U.paragraph(U.line`We use ${U.link("https://www.google.com/analytics/","Google Analytics")} to collect information about DWST usage.`,"The main motivation is to collect statistical information to aid us develop and promote the software."),R=U.paragraph("There are several ways to disable tracking.",U.line`You could use some browser extension that blocks Google Analytics or you could use the ${U.help("#local")} DWST server which should have Google Analytics disabled.`),G=U.paragraph("Google Analytics stores some information in cookies.","DWST itself uses local storage for storing command history.",U.line`You may use the built-in ${U.help("forget")} command to quickly remove stored command history.`,"Consider using tools provided by your browser for more serious cleaning."),X=U.paragraph("This describes how we do things today.","Check this page again sometime for possible updates on privacy and tracking considerations.");const{UnknownCommand:z,UnknownHelpPage:Y,UnknownInstruction:q}=o,J={"#firefox":"#unprotected","#chrome":"#unprotected","#local":"#development","#styleguide":"#development","#simulator":"#development"};function*K(t){yield"#help","#help"!==t&&(J.hasOwnProperty(t)?yield J[t]:t.endsWith("()")?yield"#functions":!1===t.startsWith("#")&&(yield"#commands"),yield t)}function Q(t="#help"){return[...K(t)].flatMap(t=>[U.unsafe(" &raquo; "),U.help(t)]).slice(1)}class Z{constructor(t){this._dwst=t}_helpPage(t){if("#help"===t)return[U.h1("Help Pages"),"",U.line`- ${U.help("#introduction")} for beginners`,U.line`- Working with ${U.help("#unprotected")} sockets`,U.line`- ${U.help("#privacy")} and tracking information`,U.line`- Alphabetical list of ${U.help("#commands")}`,U.line`- Alphabetical list of ${U.help("#functions")}`,U.line`- DWST ${U.help("#development")}`,"",U.line`Open with ${U.syntax("/help #<keyword>")}`,""];if("#chrome"===t)return[U.h1("Insecure WebSocket Access in Chrome"),"",U.line`Chrome lets you temporarily bypass the security feature that prevents you from connecting to ${U.help("#unprotected")} WebSockets.`,""].concat(M).concat(["",U.h2("Instructions"),"",U.line`1. Use ${U.help("connect")} on a ws:// address`,"2. Look for a shield icon","3. Click on the shield icon",'4. Click "Load unsafe scripts"',"5. Use connect again",""]);if("#firefox"===t)return[U.h1("Insecure WebSocket Access in Firefox"),"",U.line`Firefox lets you disable the security feature that prevents you from connecting to ${U.help("#unprotected")} WebSockets.`,""].concat(V).concat(["",U.h2("Instructions"),"","1. Go to about:config","2. Search for WebSocket","3. Set allowInsecureFromHTTPS to true",""]);if("#development"===t)return[U.h1("DWST Development"),"",U.line`- Run the ${U.help("#local")} development server`,U.line`- User interface ${U.help("#styleguide")}`,U.line`- WebSocket server ${U.help("#simulator")}`];if("#local"===t)return[U.h1("DWST Development Server"),"","You can run DWST local development server by executing the following commands in the shell near you.",""].concat(O).concat(["",U.line`This is useful if you wish to customise DWST on source code level but can also be used to access ${U.help("#unprotected")} WebSockets.`,""]);if("#styleguide"===t)return[U.h1("Living Styleguide"),"",U.paragraph(U.line`DWST is built out of custom built user interface elements which are documented in the ${U.link("/styleguide","living styleguide")}.`,"The styleguide is generated automatically from KSS metadata which is included in related CSS files.")];if("#simulator"===t)return[U.h1("Server Simulator"),"",U.paragraph("The built-in server simulator can be used for manual testing of dwst itself.","It exists so dwst developers do not have to setup or burden test servers.","It can be used for offline testing since it does not use the network."),"",U.h2("Modes"),"",U.command("/connect dwst://echo"),"returns sent messages back to you","",U.command("/connect dwst://flood"),"creates a flood of incoming messages"];if("#unprotected"===t)return[U.h1("Working with Unprotected WebSockets"),"",U.paragraph("Browsers tend to prevent unprotected WebSockets connections from secure origins.",U.line`You may encounter this problem if your target WebSocket address starts with ${U.strong("ws://")}`),"",U.h2("Use wss INSTEAD"),"",U.paragraph("The most straight forward fix is to use the secure address instead.","However, the server needs to accept secure connections for this to work."),"",U.h2("Use Dev Server"),"",U.paragraph("The connection restrictions apply to DWST since it is served over https.",U.line`You can work around the problem by setting up ${U.help("#local")} DWST server on your workstation.`),"",U.h2("Disable Security"),"",U.paragraph("Finally, you have the option of disabling related browser security features.","However, doing this will screw up your security and release testing.",U.line`Nevertheless we have instructions for ${U.help("#chrome")} and ${U.help("#firefox")}.`),""];if("#privacy"===t)return[U.h1("Privacy and Tracking Information"),"",F,"",R,"",G,"",X,""];if("#introduction"===t)return[U.h1("Introduction for Beginners"),"","DWST is used to manually interact with a WebSocket server.","",U.h2("The Very Basics"),"",U.paragraph(U.line`Use the ${U.help("connect")} command to establish a connection.`,"Type in text to send messages.",U.line`End the connection with the ${U.help("disconnect")} command when you are done.`),"",U.h2("Convenience Tools"),"",U.paragraph(U.line`Use the ${U.help("send")} and ${U.help("binary")} commands to construct more complex messages.`,U.line`Setup a periodic send with the ${U.help("interval")} command or send a burst of messages with the ${U.help("spam")} command.`),"",U.h2("In Case of Emergency"),"",U.paragraph(U.line`Use the ${U.strong("escape key")} for an emergency shutdown if you feel that things are spinning out of control.`,U.line`Click on the DWST logo or use the ${U.help("splash")} command if you get lost.`),""];if("#commands"===t){return function(t){const e=t.filter(t=>t.length>1);return[U.h1("Alphabetical List of Commands"),"",U.sectionList(e),U.line`Type ${U.syntax("/help <command>")} for usage`,""]}(this._dwst.plugins.getNames())}if("#functions"===t){return function(t){const e=t.map(t=>`${t}()`);return[U.h1("Alphabetical List of Functions"),"",U.sectionList(e),U.line`Type ${U.syntax("/help <function>")} for usage`,""]}(this._dwst.model.variables.getFunctionNames())}throw new Y(t)}_commandHelp(t){const e=this._dwst.plugins.getPlugin(t);if(null===e)throw new z(t);if(void 0===e.usage)throw new Y(t);const n=e.usage().map(U.syntax),s=e.examples().map(U.command);return[[U.h1(t),U.unsafe(" &ndash; "),e.info()],"","",U.h2("Syntax"),""].concat(n).concat(["",U.h2("Examples"),""]).concat(s).concat([""])}_functionHelp(t){const e=t.slice(0,-"()".length),n=this._dwst.model.variables.getFunction(e);if(null===n)throw new q(e);if(void 0===n.usage)throw new Y(e);const s=n.usage().map(U.syntax),r=n.examples().map(U.command);return[[U.h1(t),U.regular(" &ndash; ",!0),n.info()],"","",U.h2("Syntax"),""].concat(s).concat(["",U.h2("Examples"),""]).concat(r).concat([""])}_pageContent(t){return t.startsWith("#")?this._helpPage(t):t.endsWith("()")?this._functionHelp(t):this._commandHelp(t)}page(t){const e=this._pageContent(t);return null===e?null:[Q(t),""].concat(e)}}class tt{constructor(t,e,n,s){this.config=D,this.history=new H(e,{save:n}),this.help=new Z(t),this.connection=null,this.intervalId=null,this.variables=new j(t,s)}}function et(t=!1){const e=function(t){return t<10?`0${t}`:String(t)},n=new Date,s=`${e(n.getHours())}:${e(n.getMinutes())}<span class="dwst-time__sec">:${e(n.getSeconds())}</span>`;if(t)return s;const r=document.createElement("span");return r.setAttribute("class","dwst-time"),r.innerHTML=s,r}function nt(t){const e=t.toString(16);return e.length<2?`0${e}`:e}function*st(t){const e=new DataView(t);let n=0;for(;n<t.byteLength;){let r="";const o=[];for(let i=0;i<16;i++){if(n<t.byteLength){const t=e.getUint8(n),i=(s=t)>126||s<32?".":String.fromCharCode(s),l=nt(t);r+=i,o.push(l)}n+=1}yield[o,r]}var s}function rt(t,e,n,s){const r=t.map(t=>{const e=[];return t instanceof ArrayBuffer?e.push(...function(t){return[...st(t)].map(t=>U.hexline(...t))}(t)):e.push(t),e.map(t=>{return function(t){if("string"==typeof t)return[t];if("object"==typeof t&&!Array.isArray(t))return[t];if(!Array.isArray(t))throw new Error("error");return t}(t).map(t=>(function(t,e){const n=(()=>"string"==typeof t?U.regular(t):t)();if("object"!=typeof n)throw new Error("invalid segment");const s=n.text,r=(()=>n.hasOwnProperty("unsafe")&&!0===n.unsafe?s:i.htmlescape(s))();if("regular"===n.type){const t=document.createElement("span");return t.innerHTML=r,t}if("help"===n.type){const t=document.createElement("span"),s=["dwst-mlog__help-link-wrapper"];!1===n.wrap&&s.push("dwst-mlog__help-link-wrapper--nowrap"),t.setAttribute("class",s.join(" "));const o=document.createElement("a"),i=["dwst-mlog__help-link"];!0===n.spacing&&i.push("dwst-mlog__help-link--spacing"),!0===n.warning&&i.push("dwst-mlog__help-link--warning"),o.setAttribute("class",i.join(" "));const l=`/help ${n.section}`;o.onclick=(t=>{t.preventDefault(),e.onHelpLinkClick(l)}),o.setAttribute("href","#"),o.setAttribute("title",l);const a=document.createElement("span");if(a.innerHTML=r,o.appendChild(a),t.appendChild(o),null!==n.afterText){const e=document.createTextNode(n.afterText);t.appendChild(e)}return t}if("command"===n.type){const t=document.createElement("a");t.setAttribute("class","dwst-mlog__command-link");const n=s;t.onclick=(t=>{t.preventDefault(),e.onCommandLinkClick(n)}),t.setAttribute("href","#"),t.setAttribute("title",r);const o=document.createElement("span");return o.innerHTML=r,t.appendChild(o),t}if("hexline"===n.type){const t=i.chunkify(n.hexes,4),e=i.chunkify(s,4),r=document.createElement("span"),o=["dwst-byte-grid"];t.length<3&&o.push("dwst-byte-grid--less-than-three"),r.setAttribute("class",o.join(" "));const l=4;[...Array(4).keys()].forEach(n=>{const[s=[]]=[t[n]],[o=[]]=[e[n]],a=i.htmlescape(s.join(" ")),c=document.createElement("span");c.setAttribute("class","dwst-byte-grid__item"),c.innerHTML=a,r.appendChild(c);const u=i.htmlescape(o.join("").padEnd(l)),d=document.createElement("span");d.setAttribute("class","dwst-byte-grid__item"),d.innerHTML=u,r.appendChild(d)});const a=document.createElement("span");return a.setAttribute("class","dwst-mlog__hexline"),a.appendChild(r),a}if("code"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__code"),t.innerHTML=r,t}if("control"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__control"),t.innerHTML=r,t.setAttribute("title",n.title),t}if("strong"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__strong"),t.innerHTML=r,t}if("h1"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__h1"),t.innerHTML=r,t}if("h2"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__h2"),t.innerHTML=r,t}if("syntax"===n.type){const t=document.createElement("span");return t.setAttribute("class","dwst-mlog__syntax"),t.innerHTML=r,t}if("link"===n.type){const t=document.createElement("a");return t.setAttribute("href",n.url),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener"),t.setAttribute("class","dwst-mlog__link"),t.innerHTML=r,t}throw new Error("unknown segment type")})(t,n))})}),o=document.createElement("span");return o.classList.add("dwst-mlog"),s.textData&&o.classList.add("dwst-mlog--text-data"),s.truncated&&o.classList.add("dwst-mlog--truncated"),r.forEach(t=>{t.forEach(t=>{t.forEach(t=>{o.appendChild(t)});const e=document.createElement("br");e.setAttribute("class","dwst-mlog__br"),o.appendChild(e)})}),o}function ot(t,e,n,s){const r=et(),o=function(t){const e=document.createElement("span");return e.setAttribute("class",`dwst-direction dwst-direction--${t}`),e.innerHTML=`${t}:`,e}(e),i=rt(t,0,n,s),l=document.createElement("span");l.setAttribute("class","dwst-log-entry");const a=document.createElement("span");a.setAttribute("class","dwst-log-entry__time"),a.appendChild(r);const c=document.createElement("span");c.setAttribute("class","dwst-log-entry__direction"),c.appendChild(o);const u=document.createElement("span");return u.setAttribute("class","dwst-log-entry__content"),u.appendChild(i),l.appendChild(a),l.appendChild(c),l.appendChild(u),l}const it=" ";function*lt(t,e){let n=t.slice();for(const t of function*(t){let e=t[0];if(e===it)throw new Error("invalid color mask");let n=[];for(const s of t)s===e?n.push(e):s===it?n.push(e):(yield n.join(""),n=[s],e=s);n.length>0&&(yield n.join(""))}(e)){const e=t[0],s=n.slice(0,t.length);n=n.slice(t.length),yield{text:s,color:e}}}function at(t,e){const n=document.createElement("div");n.setAttribute("class","dwst-gfx__content");for(const[s,r]of function*(t,e){const n=t[Symbol.iterator](),s=e[Symbol.iterator]();for(;;){const t=n.next(),e=s.next();if(t.done||e.done)return;yield[t.value,e.value]}}(t,e)){const t=document.createElement("div");t.setAttribute("class","dwst-gfx__line");for(const e of lt(s,r)){const{text:n,color:s}=e,r=document.createElement("span");r.setAttribute("class",`dwst-gfx__element dwst-gfx__element--color-${s}`),r.innerHTML=n,t.appendChild(r)}n.appendChild(t)}const s=document.createElement("div");s.setAttribute("class","dwst-gfx__background");const r=document.createElement("div");r.setAttribute("class","dwst-debug__background-guide");const o=document.createElement("div");o.setAttribute("class","dwst-debug__content-guide"),r.appendChild(o),s.appendChild(r),n.appendChild(s);const i=document.createElement("div");return i.setAttribute("class","dwst-gfx"),i.setAttribute("aria-hidden","true"),i.appendChild(n),i}function ct(t){return function(t){const e="\\r",n="\\n",s=[];let r=[],o=null;for(const i of t)null===o?(r.push(i),"object"==typeof i&&(i.text===e&&(o=e),i.text===n&&(o=n))):o===e?"string"==typeof i?(s.push(r),(r=[]).push(i),o=null):i.text===e?(s.push(r),(r=[]).push(i),o=e):i.text===n?(r.push(i),s.push(r),r=[],o=null):(s.push(r),(r=[]).push(i),o=null):o===n&&("string"==typeof i?(s.push(r),(r=[]).push(i),o=null):i.text===e?(r.push(i),s.push(r),r=[],o=null):i.text===n?(s.push(r),(r=[]).push(i),o=n):(s.push(r),(r=[]).push(i),o=null));return s.push(r),s}(E(t).map(t=>"object"==typeof t?function(t){const e=(()=>{if(null!==t.nice)return t.nice;const e=t.chr.charCodeAt(0);return e<128?`\\x${`0${e.toString(16)}`.slice(-2)}`:`\\u{${e.toString(16)}}`})(),n=`${e} - ${t.name} (${t.abbr})`;return U.control(e,n)}(t):t))}class ut{constructor(t,e){this._element=t,this._dwst=e,this._limit=1e3}reset(){this._element.innerHTML=""}_addLogItem(t){const e=this._dwst.ui.screen.isUserScrolling();for(this._element.appendChild(t);this._element.childElementCount>this._limit;)this._element.removeChild(this._element.firstChild);e||this._dwst.ui.screen.scrollLog()}clearLog(){const t=document.createElement("div");t.setAttribute("class","dwst-log__clear"),this._addLogItem(t)}gfx(t,e){const n=at(t,e),s=document.createElement("div");s.setAttribute("class","dwst-log__item dwst-log__item--gfx"),s.appendChild(n),this._addLogItem(s),this._dwst.ui.updateGfxPositions()}mlog(t,e,n){const s=Object.assign({textData:!1,truncated:!1},n),r=ot(t,e,this._dwst.controller.link,s),o=document.createElement("div");o.setAttribute("class",`dwst-log__item dwst-log__item--${e}`),o.appendChild(r),this._addLogItem(o)}log(t,e){this.mlog([t],e)}blog(t,e){const n=t.byteLength;let s,r;n>1024?(r=t.slice(0,1024),s=!0):(r=t,s=!1),this.mlog([`<${t.byteLength}B of binary data>`,r],e,{truncated:s}),s&&this.log(`User interface limit exceeded! Showing 1024B of the ${n}B buffer.`,"warning")}tlog(t,e){const n=t.length;let s,r;n>4096?(r=t.slice(0,4096),s=!0):(r=t,s=!1);const o=ct(r);this.mlog(o,e,{textData:!0,truncated:s}),s&&this.log(`User interface limit exceeded! Showing 4096 of ${n} characters.`,"warning")}}class dt{constructor(t,e){this._element=t,this._dwst=e}refreshClock(){this._element.innerHTML=et(!0)}startClock(){this.refreshClock(),this._element.classList.remove("dwst-time--placeholder"),setInterval(()=>this.refreshClock(),500)}onLoad(){this.startClock()}}const{escapeForTemplateExpression:ht}=S;class mt{constructor(t,e){this._element=t,this._dwst=e}_enableDebugger(){document.documentElement.classList.add("dwst-debug--guides")}send(){const t=this._element.value;if(this._element.value="",this._dwst.model.history.select(t),"/idkfa"===t)return void this._enableDebugger();if(t.length<1)return void this._dwst.ui.terminal.mlog([U.line`type ${U.command("/help")} to list available commands`],"system");if("/"===t[0])return void this._dwst.controller.prompt.loud(t);const e=`/send ${ht(t)}`;this._dwst.controller.prompt.loud(e)}_keyHandler(t){if(13===t.keyCode)this.send();else{if(38===t.keyCode)return void(this._element.value=this._dwst.model.history.getPrevious(this._element.value));if(40===t.keyCode)return void(this._element.value=this._dwst.model.history.getNext(this._element.value))}}offerConnect(){if(""===this._element.value){const t=this._dwst.model.history.getConnectCommands(1);t.length<1?this._element.value=`/connect ${this._dwst.model.config.echoServer}`:this._element.value=t[0]}else this._dwst.model.history.select(this._element.value),this._element.value="";this._element.focus()}init(){this._element.addEventListener("keydown",t=>this._keyHandler(t))}focus(){this._element.focus()}}class ft{constructor(t,e){this._element=t,this._dwst=e}init(){this._element.addEventListener("click",()=>{this._dwst.ui.prompt.send()})}}class pt{constructor(t,e){this._element=t,this._dwst=e}connected(t){t?this._element.classList.replace("dwst-button--splash","dwst-button--splash-connected"):this._element.classList.replace("dwst-button--splash-connected","dwst-button--splash")}init(){this._element.addEventListener("click",()=>{this._dwst.controller.prompt.loud("/splash"),this._dwst.ui.screen.scrollLog()})}}class gt{constructor(t,e){this._element=t,this._dwst=e}isUserScrolling(){return this._element.scrollHeight-this._element.offsetHeight-this._element.scrollTop>1}scrollLog(){this._element.scrollTop=this._element.scrollHeight,this._dwst.ui.scrollNotification.hideScrollNotification()}}class wt{constructor(t,e){this._element=t,this._dwst=e}init(){this._element.addEventListener("click",t=>{t.preventDefault(),this._dwst.ui.screen.scrollLog()})}}class yt{constructor(t,e){this._element=t,this._dwst=e}scrollNotificationUpdate(){this._dwst.ui.screen.isUserScrolling()?this.showScrollNotification():this.hideScrollNotification()}showScrollNotification(){this._element.removeAttribute("style")}hideScrollNotification(){this._element.setAttribute("style","display: none;")}init(){setInterval(()=>this.scrollNotificationUpdate(),1e3)}}class _t{constructor(t,e){this._element=t,this._dwst=e}read(t){const e=this._element.getElementsByTagName("input")[0];e.onchange=(()=>{const n=e.files[0];this._element.innerHTML=this._element.innerHTML,t(n)}),e.click()}}class bt{constructor(t,e){this._element=t,this._dwst=e,this._resizePending=!1,this.terminal=new ut(t.getElementById("js-terminal"),this._dwst),this.clock=new dt(t.getElementById("js-clock"),this._dwst),this.prompt=new mt(t.getElementById("js-prompt"),this._dwst),this.sendButton=new ft(t.getElementById("js-send-button"),this._dwst),this.menuButton=new pt(t.getElementById("js-menu-button"),this._dwst),this.screen=new gt(t.getElementById("js-screen"),this._dwst),this.autoScrollButton=new wt(t.getElementById("js-auto-scroll-button"),this._dwst),this.scrollNotification=new yt(t.getElementById("js-scroll-notification"),this._dwst),this.fileInput=new _t(t.getElementById("js-file-input"),this._dwst)}globalKeyPress(t){if("Escape"===t.key){const t=this._dwst.model.connection;null!==t&&(t.isOpen()||t.isConnecting())?this._dwst.controller.prompt.loud("/disconnect"):this.prompt.offerConnect()}}updateGfxPositions(){Reflect.apply(Array.prototype.forEach,this._element.getElementsByClassName("dwst-gfx"),[t=>{const e=t.getElementsByClassName("dwst-gfx__line")[0],n=e.offsetWidth/e.textContent.length,s=window.innerWidth,r=Math.floor(s/n);let o=0;if(r<110){const t=110-r;o-=Math.round(t/2)}t.getElementsByClassName("dwst-gfx__content")[0].setAttribute("style",`transform: initial; margin-left: ${o}ch;`)}])}_throttledUpdateGfxPositions(){!0!==this._resizePending&&(this._resizePending=!0,setTimeout(()=>{this._resizePending=!1,this.updateGfxPositions()},100))}init(){this._element.addEventListener("keydown",t=>this.globalKeyPress(t)),this.prompt.init(),this.sendButton.init(),this.menuButton.init(),this.autoScrollButton.init(),this.scrollNotification.init(),this._dwst.controller.prompt.silent("/splash"),this.prompt.focus(),window.addEventListener("resize",()=>this._throttledUpdateGfxPositions())}onLoad(){this.clock.onLoad(),this.updateGfxPositions()}}class vt{constructor(t){this._dwst=t}onHelpLinkClick(t){this._dwst.controller.prompt.loud(t)}onCommandLinkClick(t){this._dwst.model.history.select(t),this._dwst.controller.prompt.loud(t)}}class xt{constructor(t){this._dwst=t,this._encoder=new TextEncoder}_evalFunction({name:t,args:e}){const n=this._dwst.model.variables.getVariable(t);if(null===n)throw new this._dwst.types.errors.UnknownInstruction(t);if(n instanceof T)return n.run(e);throw new this._dwst.types.errors.InvalidDataType(t,["FUNCTION"])}async _evalParticle(t){if("text"===t.type)return this._encoder.encode(t.value);if("byte"===t.type){return new Uint8Array([t.value])}if("codepoint"===t.type){const e=String.fromCodePoint(t.value);return this._encoder.encode(e)}if("variable"===t.type){const e=t.name,n=this._dwst.model.variables.getVariable(e);if(n instanceof ArrayBuffer)return new Uint8Array(n);if("string"==typeof n)return this._encoder.encode(n);if(n instanceof this._dwst.types.abstract.DwstFunction)throw new this._dwst.types.errors.InvalidDataType(e,["STRING","BINARY"]);throw new this._dwst.types.errors.UnknownVariable(e)}if("function"===t.type){const e=await this._evalFunction(t);if(e.constructor===Uint8Array)return e;if("string"==typeof e)return this._encoder.encode(e);throw new Error("unexpected function return type")}throw new Error("unexpected particle type")}async _evalTemplateExpression(t){const e=this._dwst.lib.parser.parseTemplateExpression(t);if("templateExpression"!==e.type)throw new Error("unexpected root node type");const n=await Promise.all(e.particles.map(t=>this._evalParticle(t)));return this._dwst.lib.utils.joinBuffers(n).buffer}eval(t){return this._evalTemplateExpression(t)}}class St{constructor(t){this._dwst=t}async _runPlugin(t,e){const n=this._dwst.plugins.getPlugin(t);if(null===n)throw new this._dwst.types.errors.UnknownCommand(t);return n.run(e)}run(t){const[e,...n]=t.split(" "),s=n.join(" ");this._runPlugin(e,s).catch(t=>{setTimeout(()=>{throw t})})}silent(t){const e=t.substring(1);this.run(e)}loud(t){this._dwst.ui.terminal.log(t,"command"),this.silent(t)}}class Ct{constructor(t){this._dwst=t}onConnectionOpen(t){const e=(()=>t.length<1?[]:[`Selected protocol: ${t}`])();this._dwst.ui.terminal.mlog(["Connection established."].concat(e),"system"),this._dwst.ui.menuButton.connected(!0)}onConnectionClose(t,e){const n={1000:"Normal Closure",1001:"Going Away",1002:"Protocol error",1003:"Unsupported Data",1005:"No Status Rcvd",1006:"Abnormal Closure",1007:"Invalid frame payload data",1008:"Policy Violation",1009:"Message Too Big",1010:"Mandatory Ext.",1011:"Internal Server Error",1015:"TLS handshake"},s=(()=>n.hasOwnProperty(t.code)?`${t.code} (${n[t.code]})`:`${t.code}`)(),r=(()=>t.reason.length<1?[]:[`Close reason: ${t.reason}`])(),o=(()=>null===e?[]:[`Session length: ${e}ms`])();this._dwst.ui.terminal.mlog(["Connection closed.",`Close status: ${s}`].concat(r).concat(o),"system"),this._dwst.model.connection=null,this._dwst.ui.menuButton.connected(!1)}onMessage(t){if("string"==typeof t)this._dwst.ui.terminal.tlog(t,"received");else{const e=new FileReader;e.addEventListener("load",t=>{const e=t.target.result;this._dwst.ui.terminal.blog(e,"received")}),e.readAsArrayBuffer(t)}}onError(){this._dwst.ui.terminal.log("WebSocket error.","error")}beforeSendWhileConnecting(t){this._dwst.ui.terminal.log(`Attempting to send data while ${t}`,"warning")}onSend(t){"string"==typeof t?this._dwst.ui.terminal.tlog(t,"sent"):this._dwst.ui.terminal.blog(t,"sent")}}const{NoConnection:$t,AlreadyConnected:kt,SocketError:Et,InvalidTemplateExpression:At,InvalidArgument:Tt,InvalidCombination:It,InvalidUtf8:Lt,InvalidDataType:Pt,InvalidVariableName:Nt,UnknownCommand:Ut,UnknownInstruction:Wt,UnknownHelpPage:Dt,UnknownVariable:Bt}=o;function Ht(t){if(0===t.length)throw new Error("list has to have at least one item");if(1===t.length)return t[0];const e=t[t.length-1];return`${t.slice(0,t.length-1).join(", ")} or ${e}`}class jt{constructor(t){this._dwst=t}_errorToMLog(t){if(t instanceof $t)return["No connection.",`Cannot send: ${t.msg}`,U.line`Use ${U.help("connect")} to form a connection and try again.`];if(t instanceof kt)return["Already connected to a server",U.line`Type ${U.command("/disconnect")} to end the connection`];if(t instanceof Et)return["WebSocket error."];if(t instanceof At){const e=" ".repeat(t.errorPosition),n=Ht(t.expected),s=t.remainder.charAt(0);return["Invalid template.",t.expression,`${e}^`,`Expected ${n}, but got "${s}" instead.`]}if(t instanceof Tt)return[`Invalid argument: ${t.argument}`,t.extraInfo];if(t instanceof It)return[U.line`Invalid ${U.help(t.command)} command combination.`,`Compatible commands: ${t.commands.join(", ")}`];if(t instanceof Lt)return[`Utf-8 decoder failed to process ${t.buffer.byteLength}B buffer`,`${t.buffer}`];if(t instanceof Pt)return[`Variable ${t.variable} is not a ${Ht(t.expected)}`];if(t instanceof Nt)return[`Invalid variable name ${t.variable}`];if(t instanceof Ut)return[U.line`Unknown command ${U.strong(t.command)}`,U.line`Type ${U.command("/help #commands")} to list available commands`];if(t instanceof Wt)return[U.line`Unknown function ${U.strong(t.instruction)}`,U.line`Type ${U.command("/help #functions")} to list available functions`];if(t instanceof Dt)return[`Unkown help page: ${t.page}`,U.line`Display help index by typing ${U.command("/help")}`];if(t instanceof Bt)return[`Variable "${t.variable}" does not exist.`,U.line`List available variables by typing ${U.command("/vars")}`];throw new Error(`missing error handler for ${t.constructor.name}`)}onDwstError(t){this._dwst.ui.terminal.mlog(this._errorToMLog(t),"error")}}class Mt{constructor(t){this._dwst=t,this._prompt=null}beforeInstallPrompt(t){this._prompt=t,this._dwst.ui.terminal.mlog([U.line`Type ${U.command("/pwa install")} to install`],"system")}onInstall(){null!==this._prompt?(this._prompt.prompt(),this._prompt=null):this._dwst.ui.terminal.mlog(["Installation not possible","","Possible reasons:","  * App already installed","  * App not frequently used","  * Browser has no PWA support","",'You could try manual pwa installation with "Add to home screen" or similar browser feature'],"warning")}}class Ot extends T{constructor(t){super(),this._dwst=t}commands(){return["byteRange"]}usage(){return["byteRange(<start>, <end>)"]}examples(){return["/s From a to z: ${byteRange(97,122)}","/b ${byteRange(0,0xff)}"]}info(){return"generate sequential bytes"}run(t){let e=0,n=255;1===t.length&&(n=t[0].value),2===t.length&&(e=t[0].value,n=t[1].value);const s=[];for(let t=e;t<=n;t++)s.push(t);return new Uint8Array(s)}}class Vt extends T{constructor(t){super(),this._dwst=t}commands(){return["charRange"]}usage(){return["charRange(<start>, <end>)"]}examples(){return["/s From a to z: ${charRange(97,122)}","/s ${charRange(0x2600,0x2603)}","/b ${charRange(0x2600,0x2603)}"]}info(){return"generate sequential utf-8 encoded characters"}run(t){let e=32,n=126;1===t.length&&(n=t[0].value),2===t.length&&(e=t[0].value,n=t[1].value);let s="";for(let t=e;t<=n;t++)s+=String.fromCodePoint(t);return s}}class Ft extends T{constructor(t){super(),this._dwst=t}commands(){return["file"]}usage(){return["file()"]}examples(){return["/s ${file()}","/b ${file()}","/set foo ${file()}"]}info(){return"read file from filesystem"}_readFile(){return new Promise(t=>{this._dwst.ui.fileInput.read(e=>{const n=new FileReader;n.addEventListener("load",e=>{const n=e.target.result;t(n)}),n.readAsArrayBuffer(e)})})}async run(){const t=await this._readFile();return new Uint8Array(t)}}class Rt extends T{constructor(t){super(),this._dwst=t}commands(){return["randomBytes"]}usage(){return["randomBytes(<number>)"]}examples(){return["/b ${randomBytes(16)}"]}info(){return"generate random bytes"}run(t){let e=16;1===t.length&&(e=t[0].value);const n=[];for(let t=0;t<e;t++)n.push(Math.floor(256*Math.random()));return new Uint8Array(n)}}class Gt extends T{constructor(t){super(),this._dwst=t}commands(){return["randomChars"]}usage(){return["randomChars(<number>)"]}examples(){return["/s ${randomChars(10)}","/b ${randomChars(10)}"]}info(){return"generate random utf-8 encoded characters"}run(t){const e=()=>{const t=Math.floor(65536*Math.random());return String.fromCodePoint(t)};let n=16;1===t.length&&(n=t[0].value);let s="";for(let t=0;t<n;t++)s+=e();return s}}class Xt extends T{constructor(t){super(),this._dwst=t}commands(){return["time"]}usage(){return["time()"]}examples(){return["/s ${time()}s since epoch","/b ${time()}"]}info(){return"generate utf-8 encoded timestamp"}run(){return String(Math.round((new Date).getTime()/1e3))}}class zt{constructor(t){this.url=t,this.protocol="",this.readyState=1,this._path=t.split("//").pop(),this._nextFlood=null,window.setTimeout(()=>{this.onopen(),"flood"===this._path&&this._flood(0)},0)}_flood(t){this._nextFlood=window.setTimeout(()=>{this.onmessage({data:`${t}`}),this._flood(t+1)},0)}send(t){if("echo"===this._path){const e=(()=>{if("string"==typeof t)return t;if(t instanceof ArrayBuffer)return new Blob([new Uint8Array(t)]);throw new Error("Unexpected message type")})();window.setTimeout(()=>{this.onmessage({data:e})},0)}}close(){window.clearTimeout(this._nextFlood),this.readyState=3,this.onclose({code:1e3,reason:""})}}class Yt{constructor(t,e=[],n){this._controller=n,this.sessionStartTime=null,this.ws=(()=>{const n=(()=>t.startsWith("dwst://")?zt:WebSocket)();return e.length<1?new n(t):new n(t,e)})(),this.ws.onopen=this._onopen.bind(this),this.ws.onclose=this._onclose.bind(this),this.ws.onmessage=this._onmessage.bind(this),this.ws.onerror=this._onerror.bind(this)}_onopen(){this.sessionStartTime=(new Date).getTime(),this._controller.onConnectionOpen(this.ws.protocol)}_onclose(t){const e=(()=>{if(null===this.sessionStartTime)return null;return(new Date).getTime()-this.sessionStartTime})();this._controller.onConnectionClose(t,e)}_onmessage(t){this._controller.onMessage(t.data)}_onerror(){this._controller.onError()}get url(){return this.ws.url}get verb(){const t=this.ws.readyState;if(0===t)return"connecting";if(1===t)return"connected";if(2===t)return"closing connection";if(3===t)return"hanging on an already closed connection";throw new Error("Unkown readyState")}get protocol(){return this.ws.protocol}send(...t){1!==this.ws.readyState&&this._controller.beforeSendWhileConnecting(this.verb),this._controller.onSend(...t),this.ws.send(...t)}close(){this.ws.close()}isConnecting(){return 0===this.ws.readyState}isOpen(){return 1===this.ws.readyState}isClosing(){return 2===this.ws.readyState}isClosed(){return 3===this.ws.readyState}}const qt=Object.seal({lib:A,types:W,model:null,ui:null,controller:null,plugins:null,functions:null});qt.model=function(t){const e=localStorage.getItem("history");let n=[];return null!==e&&(n=JSON.parse(e)),new tt(t,n,function(t){const e=JSON.stringify(t);localStorage.setItem("history",e)},[Ot,Vt,Ft,Rt,Gt,Xt])}(qt),qt.controller=new class{constructor(t){this.link=new vt(t),this.template=new xt(t),this.prompt=new St(t),this.socket=new Ct(t),this.error=new jt(t),this.pwa=new Mt(t)}}(qt),qt.plugins=new class{constructor(t,e){this._commands=new Map;for(const n of e){const e=new n(t);for(const t of e.commands())this._commands.set(t,e)}}getPlugin(t){const e=this._commands.get(t);return void 0===e?null:e}getNames(){return[...this._commands.keys()]}}(qt,[class{constructor(t){this._dwst=t}commands(){return["binary","b"]}usage(){return["/binary [template]","/b [template]"]}examples(){return["/binary Hello world!",'/binary ["JSON","is","cool"]',"/binary multiline\\r\\nmessage","/binary null terminated string\\0one more\\0","/binary tab\\x09separated\\x09strings","/binary unicode snowman \\u2603","/binary unicode tea cup \\u{1f375}","/b Available now with ~71.43% less typing!"]}info(){return"send binary data"}async run(t){const e=await this._dwst.controller.template.eval(t),n=`<${e.byteLength}B of data> `,s=this._dwst.model.connection;if(null===s||s.isClosing()||s.isClosed())throw new this._dwst.types.errors.NoConnection(n);this._dwst.model.connection.send(e)}},class{constructor(t){this._dwst=t}commands(){return["clear"]}usage(){return["/clear"]}examples(){return["/clear"]}info(){return"clear the screen"}run(){this._dwst.ui.terminal.clearLog()}},class{constructor(t){this._dwst=t}commands(){return["connect"]}usage(){return["/connect <ws-url> [p1[,p2[,...]]]"]}examples(){return["/connect wss://echo.websocket.org/","/connect ws://echo.websocket.org/","/connect ws://127.0.0.1:1234/ protocol1.example.com,protocol2.example.com"]}info(){return"connect to a server"}_run(t,e=""){const n=this._dwst.types.m;if(null!==this._dwst.model.connection)throw new this._dwst.types.errors.AlreadyConnected;const s=(()=>""===e?[]:e.split(","))().filter(t=>{const e=this._dwst.lib.utils.range(33,126).map(t=>String.fromCharCode(t)),n=new Set([...'()<>@,;:\\"/[]?={} \t']),s=new Set(e.filter(t=>!n.has(t))),r=[...t],o=[...new Set(r.filter(t=>!s.has(t)))];if(o.length>0){const e=o.map(t=>`"${t}"`).join(", ");return this._dwst.ui.terminal.mlog([`Skipped invalid protocol candidate "${t}".`,`The following characters are not allowed: ${e}`],"warning"),!1}return!0});if(self.origin.startsWith("https://")&&t.startsWith("ws://")){const s=`/connect ${`wss://${t.slice("ws://".length)}`} ${e}`;this._dwst.ui.terminal.mlog([n.line`Attempting unprotected connection from a secure origin. See ${n.help("#unprotected")} for details. Consider using ${n.command(s)}`],"warning")}this._dwst.model.connection=new Yt(t,s,this._dwst.controller.socket);const r=s.join(", "),o=(()=>s.length<1?["No protocol negotiation."]:[`Accepted protocols: ${r}`])();this._dwst.ui.terminal.mlog([`Connecting to ${this._dwst.model.connection.url}`].concat(o),"system")}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}},class{constructor(t){this._dwst=t}commands(){return["disconnect"]}usage(){return["/disconnect"]}examples(){return["/disconnect"]}info(){return"disconnect from a server"}run(){null!==this._dwst.model.connection?(this._dwst.ui.terminal.mlog([`Closing connection to ${this._dwst.model.connection.url}`].concat([]),"system"),this._dwst.model.connection.close()):this._dwst.ui.terminal.log("No connection to disconnect","warning")}},class{constructor(t){this._dwst=t}commands(){return["forget"]}usage(){return["/forget everything"]}examples(){return["/forget everything"]}info(){return"empty history"}_removeHistory(){this._dwst.model.history.forget();const t=this._dwst.model.history.getSummary().concat(["."]);this._dwst.ui.terminal.mlog(["Successfully forgot stored history!",t],"system")}_run(t){if("everything"!==t){const e=this._dwst.model.history.getSummary().concat(["."]);throw new this._dwst.types.errors.InvalidArgument(t,e)}this._removeHistory(),this._dwst.ui.terminal.log("You may wish to use your browser's cleaning features to remove tracking cookies and other remaining traces.","warning")}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}},class{constructor(t){this._dwst=t}commands(){return["help"]}usage(){return["/help","/help <command>"]}examples(){return["/help","/help send","/help binary"]}info(){return"get help"}_run(t="#help"){this._dwst.ui.terminal.clearLog();const e=this._dwst.model.help.page(t);this._dwst.ui.terminal.mlog(e,"system")}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}},class{constructor(t){this._dwst=t}commands(){return["interval"]}usage(){return["/interval <interval> [command line...]","/interval"]}examples(){return["/interval 1000","/interval 1000 /binary ${randomBytes(10)}","/interval"]}info(){return"run an other command periodically"}_run(t=null,...e){if(null===t)return null===this._dwst.model.intervalId?void this._dwst.ui.terminal.log("No interval to clear","warning"):(clearInterval(this._dwst.model.intervalId),this._dwst.model.intervalId=null,void this._dwst.ui.terminal.log("interval cleared","system"));const[n,s]=(()=>{if(e.length<1)return["send",null];const t=e[0],n=e.slice(1);if(!1===["/s","/send","/b","/binary"].includes(t))throw new this._dwst.types.errors.InvalidCombination("interval",["send","binary"]);return[t.slice(1),n.join(" ")]})();let r=0;const o=this._dwst.lib.utils.parseNum(t);null!==this._dwst.model.intervalId&&(this._dwst.ui.terminal.log("clearing old interval","system"),clearInterval(this._dwst.model.intervalId),this._dwst.model.intervalId=null),this._dwst.model.intervalId=setInterval(()=>{const t=(()=>null===s?String(r):s)();if(null!==this._dwst.model.connection&&!1!==this._dwst.model.connection.isOpen())this._dwst.controller.prompt.run([n,t].join(" ")),r+=1;else if(null!==this._dwst.model.intervalId)throw clearInterval(this._dwst.model.intervalId),this._dwst.model.intervalId=null,new this._dwst.types.errors.NoConnection(t)},o),this._dwst.ui.terminal.log("interval set","system")}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}},class{constructor(t){this._dwst=t}commands(){return["pwa"]}usage(){return["/pwa <action>"]}examples(){return["/pwa install"]}info(){return"control progressive web application features"}run(...t){"install"===t[0]&&this._dwst.controller.pwa.onInstall()}},class{constructor(t){this._dwst=t}commands(){return["reset"]}usage(){return["/reset"]}examples(){return["/reset"]}info(){return"reset the message buffer"}run(){this._dwst.ui.terminal.reset()}},class{constructor(t){this._dwst=t,this._encoder=new TextDecoder("utf-8",{fatal:!0})}commands(){return["send","s",""]}usage(){return["/send [template]","/s [template]"]}examples(){return["/send Hello world!",'/send ["JSON","is","cool"]',"/send multiline\\r\\nmessage","/send null terminated string\\0one more\\0","/send tab\\x09separated\\x09strings","/send unicode snowman \\u2603","/send unicode tea cup \\u{1f375}","/s Available now with 60% less typing!"]}info(){return"send textual data"}_encode(t){try{return new TextDecoder("utf-8",{fatal:!0}).decode(t)}catch(e){if(e instanceof TypeError)throw new this._dwst.types.errors.InvalidUtf8(t);throw e}}async run(t){const e=await this._dwst.controller.template.eval(t),n=this._encode(e),s=this._dwst.model.connection;if(null===s||s.isClosing()||s.isClosed())throw new this._dwst.types.errors.NoConnection(n);this._dwst.model.connection.send(n)}},class{constructor(t){this._dwst=t}commands(){return["set"]}usage(){return["/set <variable> <value>"]}examples(){return["/set foo 123"]}info(){return"set variable"}async run(t){const[e,...n]=t.split(" ");if(0===e.length)throw new this._dwst.types.errors.InvalidArgument(e,["expected variable name"]);const s=n.join(" "),r=await this._dwst.controller.template.eval(s);this._dwst.model.variables.setVariable(e,r),this._dwst.ui.terminal.mlog([`${r.byteLength}B of data stored in variable ${e}`],"system")}},class{constructor(t){this._dwst=t}commands(){return["spam"]}usage(){return["/spam <times> [command line...]"]}examples(){return["/spam 10","/spam 6 /binary ${randomBytes(10)}"]}info(){return"run a command multiple times"}_run(t,...e){const n=this._dwst.lib.utils.parseNum(t),[s,r]=(()=>{if(e.length<1)return["send",null];const t=e[0],n=e.slice(1);if(!1===["/s","/send","/b","/binary"].includes(t))throw new this._dwst.types.errors.InvalidCombination("spam",["send","binary"]);return[t.slice(1),n.join(" ")]})(),o=(t,e=0)=>{if(e===t)return;const n=(()=>null===r?String(e):r)();if(null===this._dwst.model.connection||!1===this._dwst.model.connection.isOpen())throw new this._dwst.types.errors.NoConnection(n);this._dwst.controller.prompt.run([s,n].join(" ")),setTimeout(()=>{o(t,e+1)},0)};o(n)}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}},class{constructor(t){this._dwst=t}commands(){return["splash"]}usage(){return["/splash"]}examples(){return["/splash"]}info(){return"revisit welcome screen"}run(){const t=this._dwst.types.m;this._dwst.ui.terminal.clearLog();const e=["7                                                                                                             ","7                                                                                                             ","7                                                                                                             ","7                                                                                                             ","7                                  77777                                                                      ","4                                    444                                                                      ","4                                     447                                                                     ","4                                      44                                 7777                                ","4                                      44                                 44                                  ","7                                  7774 44  777       7777   77777777     4                                   ","7                                774  4444 444         4447 74      477  74                                   ","4                                44     44444           444 444       47744444                                ","4                                44     4444             447 44444444  44                                     ","2                                222     222     222      22       222 22                                     ","2                                 222   22222   22222   222 22     222 222                                    ","2                                  2222222 2222222 2222222  222222222   2222                                  ","2                                                                                                             ","2                                                                                                             ","2                                                                                                             "];let n=["f                                                                                                             ","f                                                                                                             ","f                                                                                                             ","f                                                                                                             ","f                                  fffff                                                                      ","f                                    fff                                                                      ","f                                     fff                                                                     ","f                                      ff                                 ffff                                ","f                                      ff                                 ff                                  ","f                                  ffff ff  fff       ffff   ffffffff     f                                   ","f                                fff  ffff fff         ffff ff      fff  ff                                   ","f                                ff     fffff           fff fff       ffffffff                                ","f                                ff     ffff             fff ffffffff  ff                                     ","5                                555     555     555      55       555 55                                     ","5                                 555   55555   55555   555 55     555 555                                    ","5                                  5555555 5555555 5555555  555555555   5555                                  ","5                                                                                                             ","5                                                                                                             ","5                                                                                                             "];const s=new Date,r=s.getDate(),o=s.getMonth();24===r&&11===o&&(n=e);const i=this._dwst.model.history.getSummary(),l=this._dwst.model.history.getConnectCommands(4),a=l.slice(0,3),c=a.map(e=>t.line`${t.command(e)}`),u=(()=>l.length>3?["(more than 3 in total, hiding some)"]:[])(),d=[i.concat(t.line`, including ${t.help("connect")} commands`)].concat(c).concat(u),h=(()=>{if(null===this._dwst.model.connection)return[];const e=t.line`Currently ${this._dwst.model.connection.verb} to ${t.strong(this._dwst.model.connection.url)}`,n=(()=>{const e=this._dwst.model.connection.protocol;return e.length<1?[]:[t.line`Selected protocol: ${t.strong(e)}`]})(),s=[t.line`Type ${t.command("/disconnect")} to end the connection`];return[e].concat(n).concat(["",s])})(),m=[t.line`${t.h1(`Dark WebSocket Terminal ${this._dwst.model.config.appVersion}`)}`],f=[t.line`1. Create a test connection by typing ${t.command(`/connect ${this._dwst.model.config.echoServer}`)}`,"2. Type messages into the text input","3. Click on DWST logo if you get lost"],p=[t.line`Type ${t.command("/help")} to see the full range of available commands`],g=[t.line`${t.help("Check","#privacy",{warning:!0})} privacy and tracking info`],w=[t.line`${t.link("https://github.com/dwst/dwst","GitHub")}${t.unsafe(" &bull; ")}${t.link("https://gitter.im/dwst/dwst","chat")}${t.unsafe(" &bull; ")}${t.link("https://tools.ietf.org/html/rfc6455","rfc6455")}${t.unsafe(" &bull; ")}${t.link("https://www.iana.org/assignments/websocket/websocket.xhtml","iana")}`],y=(()=>null!==this._dwst.model.connection?[m,[""],h,[""],p,[""],w,[""]]:a.length>0?[m,[""],d,[""],g,[""],p,[""],w,[""]]:[m,[""],f,[""],g,[""],p,[""],w,[""]])();this._dwst.ui.terminal.gfx(["                                                                                                              ","                                                                                                              ","                                                                                                              ","                                                                                                              ","                                   `ggg.                                                                      ","                                     ggg                                                                      ","                                      gg.                                                                     ","                                       gg                                 ggg'                                ","                                       gg                                 gg                                  ","                                   ,ggg g.  ggg       ggg.   .gggggg.     g                                   ","                                 ,gg  `ggg ggg         ggg. gg      `g.  gg                                   ","                                 gg     gg.g'           `gg gg.       `gggggg'                                ","                                 gg     ggg'             gg. 'gggggg.  ,g                                     ","                                 ll.     ll.     ,l.      ll       `ll l.                                     ","                                  ll.   llll.   ,lll.   ,ll l`     ,ll ll.                                    ","                                   `lllll' `lllll' `lllll'  `lllllll'   lll.                                  ","                                                                                                              ","                                                                                                              ","                                                                                                              "],n),this._dwst.ui.terminal.mlog([].concat(...y),"system")}},class{constructor(t){this._dwst=t}commands(){return["unset"]}usage(){return["/unset <variable>"]}examples(){return["/unset foo"]}info(){return"delete variable"}run(t){if(0===t.length)throw new this._dwst.types.errors.InvalidArgument(t,["expected variable name"]);if(null===this._dwst.model.variables.getVariable(t))throw new this._dwst.types.errors.UnknownVariable(t);this._dwst.model.variables.deleteVariable(t),this._dwst.ui.terminal.mlog([`Variable ${t} deleted`],"system")}},class{constructor(t){this._dwst=t}commands(){return["vars"]}usage(){return["/vars","/vars [name]"]}examples(){return["/vars","/vars foo"]}info(){return"list variables"}_run(t=null){if(null!==t){const e=this._dwst.model.variables.getVariable(t);if("string"==typeof e)return void this._dwst.ui.terminal.tlog(e,"system");if(e instanceof ArrayBuffer)return void this._dwst.ui.terminal.blog(e,"system");if(e instanceof this._dwst.types.abstract.DwstFunction)return void this._dwst.ui.terminal.blog("<function>","system");throw new this._dwst.lib.errors.UnknownVariable(t)}const e=this._dwst.model.variables.getVariableNames();if(0===e.length)return void this._dwst.ui.terminal.log("No variables in memory.","system");const n=[...e].map(t=>{const e=this._dwst.model.variables.getVariable(t);if("string"==typeof e)return`${t} <${(new TextEncoder).encode(e).byteLength}B of utf-8 text>`;if(e instanceof ArrayBuffer)return`${t} <${e.byteLength}B of binary data>`;throw new Error("unexpected variable type")}),s=["Loaded vars:"].concat(n);this._dwst.ui.terminal.mlog(s,"system")}run(t){if(t.length<1)return void this._run();const e=t.split(" ");this._run(...e)}}]),document.addEventListener("DOMContentLoaded",()=>{qt.ui=new bt(document,qt),qt.ui.init()}),window.addEventListener("load",()=>{qt.ui.onLoad(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service_worker.js")}),window.addEventListener("error",t=>{t.error instanceof r&&(t.preventDefault(),qt.controller.error.onDwstError(t.error))}),window.addEventListener("beforeinstallprompt",t=>{qt.controller.pwa.beforeInstallPrompt(t)}),window._dwst=qt}]);
//# sourceMappingURL=dwst.js.map